---
// App Layout - For authenticated pages with navigation
import '../styles/globals.css';
import Navigation from '../components/Navigation.astro';
import { getCurrentUser } from '../lib/supabase/server';

interface Props {
  title?: string;
  description?: string;
  hideNavigation?: boolean;
}

const { title = 'Utopía', description = 'Red social en tiempo real', hideNavigation = false } = Astro.props;

// Check if user is authenticated - but don't redirect server-side
// Let the client-side handle the redirect to avoid ResponseSentError
const user = await getCurrentUser(Astro);
const isAuthenticated = !!user;
---

<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=Sora:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <title>{title} | Utopía</title>
  </head>

  <body class:list={['app-body', { 'no-nav': hideNavigation }]}>
    { !hideNavigation && <Navigation /> }
    <main class="app-main">
      <div class="app-container">
        <!-- Left Sidebar -->
        <aside class="sidebar-left" aria-label="Left sidebar">
          <div class="sidebar-content glass">
            <slot name="sidebar-left" />
          </div>
        </aside>

        <!-- Main Content -->
        <div class="main-content">
          <slot />
        </div>

        <!-- Right Sidebar -->
        <aside class="sidebar-right" aria-label="Right sidebar">
          <div class="sidebar-content glass">
            <slot name="sidebar-right" />
          </div>
        </aside>
      </div>
    </main>

    <!-- Bottom Navigation for Mobile -->
    { !hideNavigation && (
    <nav class="bottom-nav" aria-label="Mobile navigation">
      <a href="/feed" class="bottom-nav-item" data-active="false">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
          <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
        <span>Inicio</span>
      </a>
      <a href="/map" class="bottom-nav-item" data-active="false">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
          <circle cx="12" cy="10" r="3"></circle>
        </svg>
        <span>Mapa</span>
      </a>
      <a href="/messages-mobile" class="bottom-nav-item messages-btn" data-active="false">
        <div class="messages-icon-wrap">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          </svg>
          <span class="messages-badge" id="mobile-message-count" hidden>0</span>
        </div>
        <span>Chat</span>
      </a>
      <a href="/radio" class="bottom-nav-item create-btn" data-active="false">
        <div class="create-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="8"></circle>
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M12 2v2m0 16v2m10-10h-2M4 12H2"></path>
          </svg>
        </div>
      </a>
      <a href="/reels" class="bottom-nav-item" data-active="false">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"></rect>
          <line x1="7" y1="2" x2="7" y2="22"></line>
          <line x1="17" y1="2" x2="17" y2="22"></line>
          <line x1="2" y1="12" x2="22" y2="12"></line>
        </svg>
        <span>Reels</span>
      </a>
      <a href="/notifications" class="bottom-nav-item" data-active="false">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
          <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
        </svg>
        <span>Alertas</span>
      </a>
      <a href="/profile" class="bottom-nav-item" data-active="false">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
        <span>Perfil</span>
      </a>
    </nav>
    )}
  </body>
</html>

<style>
  .app-body {
    margin: 0;
    padding: 0;
    font-family: 'Sora', 'Manrope', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: #0b0f0e;
    color: #fff;
    min-height: 100vh;
    overflow-x: hidden;
  }

  .app-body.no-nav .app-main {
    padding-top: 0;
    padding-bottom: 0;
  }

  .app-body.no-nav .app-container {
    padding: 0;
    max-width: 100%;
    grid-template-columns: 1fr;
  }

  .app-body.no-nav .sidebar-left,
  .app-body.no-nav .sidebar-right {
    display: none !important;
  }

  .app-main {
    padding-top: 64px;
    min-height: 100vh;
    padding-bottom: 80px;
  }

  @media (min-width: 768px) {
    .app-main {
      padding-bottom: 0;
    }
  }

  .app-container {
    display: grid;
    grid-template-columns: 1fr;
    max-width: 1400px;
    margin: 0 auto;
    padding: 1rem;
    gap: 1rem;
  }

  @media (min-width: 1024px) {
    .app-container {
      grid-template-columns: 280px 1fr 320px;
      padding: 1.5rem;
      gap: 1.5rem;
    }
  }

  @media (min-width: 768px) and (max-width: 1023px) {
    .app-container {
      grid-template-columns: 1fr 280px;
    }
  }

  .sidebar-left,
  .sidebar-right {
    display: none;
  }

  @media (min-width: 1024px) {
    .sidebar-left,
    .sidebar-right {
      display: block;
    }
  }

  @media (min-width: 768px) and (max-width: 1023px) {
    .sidebar-right {
      display: block;
    }
  }

  .sidebar-content {
    position: sticky;
    top: 80px;
    padding: 1.25rem;
    border-radius: 1rem;
    background: rgba(19, 25, 23, 0.7);
    border: 1px solid rgba(34, 197, 94, 0.12);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    max-height: calc(100vh - 100px);
    overflow-y: auto;
  }

  .main-content {
    min-width: 0;
  }

  /* Bottom Navigation */
  .bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    display: flex;
    align-items: center;
    justify-content: space-around;
    height: 64px;
    background: linear-gradient(
      180deg,
      rgba(10, 10, 10, 0.9) 0%,
      rgba(10, 10, 10, 0.98) 100%
    );
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-top: 1px solid rgba(34, 197, 94, 0.15);
    padding: 0 0.5rem;
    z-index: 100;
  }

  @media (min-width: 768px) {
    .bottom-nav {
      display: none;
    }
  }

  .bottom-nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 0.5rem;
    text-decoration: none;
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.625rem;
    font-weight: 500;
    gap: 0.25rem;
    transition: all 0.2s ease;
    min-width: 60px;
  }

  .bottom-nav-item svg {
    width: 22px;
    height: 22px;
  }

  .bottom-nav-item:hover,
  .bottom-nav-item[data-active="true"] {
    color: #22c55e;
  }

  .create-btn {
    padding: 0;
  }

  .create-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 44px;
    height: 44px;
    background: linear-gradient(135deg, #22c55e 0%, #15803d 100%);
    border-radius: 50%;
    color: #fff;
    box-shadow: 0 4px 15px rgba(34, 197, 94, 0.35);
    transition: all 0.2s ease;
  }

  .create-icon:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
  }

  .create-icon svg {
    width: 22px;
    height: 22px;
  }

  /* Messages button */
  .messages-btn {
    position: relative;
  }

  .messages-icon-wrap {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .messages-badge {
    position: absolute;
    top: -4px;
    right: -8px;
    min-width: 16px;
    height: 16px;
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    border-radius: 8px;
    font-size: 0.6rem;
    font-weight: 700;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 4px;
    border: 2px solid #0a0a0a;
  }

  .messages-badge[hidden] {
    display: none;
  }

  /* Scrollbar styling */
  .sidebar-content::-webkit-scrollbar {
    width: 4px;
  }

  .sidebar-content::-webkit-scrollbar-track {
    background: transparent;
  }

  .sidebar-content::-webkit-scrollbar-thumb {
    background: rgba(34, 197, 94, 0.25);
    border-radius: 2px;
  }

  .sidebar-content::-webkit-scrollbar-thumb:hover {
    background: rgba(34, 197, 94, 0.4);
  }
</style>

<script>
  import { supabase } from '../lib/supabase/client';
  
  let presenceHeartbeat: ReturnType<typeof setInterval> | null = null;

  async function upsertPresence(status = 'online') {
    const { data: { user } } = await supabase.auth.getUser();
    
    if (!user) return;

    await (supabase as any).from('user_presence').upsert({
      user_id: user.id,
      status,
      last_seen: new Date().toISOString(),
      device: navigator.userAgent.slice(0, 60),
    });
  }

  function initPresenceTracking() {
    upsertPresence('online');

    presenceHeartbeat = setInterval(() => {
      const status = document.visibilityState === 'visible' ? 'online' : 'away';
      upsertPresence(status);
    }, 30000);

    document.addEventListener('visibilitychange', () => {
      const status = document.visibilityState === 'visible' ? 'online' : 'away';
      upsertPresence(status);
    });

    window.addEventListener('beforeunload', () => {
      upsertPresence('offline');
      if (presenceHeartbeat) {
        clearInterval(presenceHeartbeat);
      }
    });
  }
  
  // Client-side auth check - redirect to login if not authenticated
  async function checkAuth() {
    const { data: { session } } = await supabase.auth.getSession();
    
    if (!session) {
      // Not authenticated, redirect to login
      window.location.href = '/login';
      return;
    }

    initPresenceTracking();
    
    // Listen for auth state changes
    supabase.auth.onAuthStateChange((event) => {
      if (event === 'SIGNED_OUT') {
        upsertPresence('offline');
        window.location.href = '/login';
      }
    });
  }
  
  // Run auth check immediately
  checkAuth();
  
  // Set active bottom nav item based on current path
  const currentPath = window.location.pathname;
  document.querySelectorAll('.bottom-nav-item').forEach(item => {
    const href = item.getAttribute('href');
    if (href && currentPath.startsWith(href) && href !== '/') {
      item.setAttribute('data-active', 'true');
    }
  });
</script>