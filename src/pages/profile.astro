---
// Profile page - User profile with stats and settings
import AppLayout from "../layouts/AppLayout.astro";
import ProfileHeader from "../components/react/ProfileHeader";
import { getCurrentUser } from "../lib/supabase/server";
import { supabase } from "../lib/supabase/client";

const user = await getCurrentUser(Astro);
let profile = null;

if (user) {
  const { data } = await supabase
    .from("profiles")
    .select("*")
    .eq("id", user.id)
    .single();
  profile = data;
}
---

<AppLayout title="Perfil - Utopía">
  <div class="profile-page">
    <ProfileHeader
      client:visible
      initialProfile={profile}
      isOwnProfile={true}
    />

    <!-- Profile Content Tabs -->
    <div class="profile-tabs">
      <button class="tab-btn active" data-tab="posts">
        <svg
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <rect x="3" y="3" width="7" height="7"></rect>
          <rect x="14" y="3" width="7" height="7"></rect>
          <rect x="14" y="14" width="7" height="7"></rect>
          <rect x="3" y="14" width="7" height="7"></rect>
        </svg>
        <span>Posts</span>
      </button>
      <button class="tab-btn" data-tab="reels">
        <svg
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <polygon points="23 7 16 12 23 17 23 7"></polygon>
          <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
        </svg>
        <span>Reels</span>
      </button>
      <button class="tab-btn" data-tab="saved">
        <svg
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
        </svg>
        <span>Guardados</span>
      </button>
      <button class="tab-btn" data-tab="tagged">
        <svg
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path
            d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"
          ></path>
          <line x1="7" y1="7" x2="7.01" y2="7"></line>
        </svg>
        <span>Etiquetados</span>
      </button>
      <button class="tab-btn" data-tab="friends">
        <svg
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
          <circle cx="9" cy="7" r="4"></circle>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
        </svg>
        <span>Amigos</span>
      </button>
    </div>

    <!-- Posts Grid -->
    <div class="posts-grid" id="posts-grid">
      <!-- Posts will be loaded dynamically -->
      <div class="empty-state">
        <svg
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="1.5"
        >
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <circle cx="8.5" cy="8.5" r="1.5"></circle>
          <polyline points="21 15 16 10 5 21"></polyline>
        </svg>
        <h3>No hay publicaciones aún</h3>
        <p>Cuando publiques contenido, aparecerá aquí.</p>
        <a href="/feed" class="btn btn-primary">Crear primera publicación</a>
      </div>
    </div>
  </div>
</AppLayout>

<style>
  .profile-page {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .profile-tabs {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.5rem;
    background: rgba(18, 18, 18, 0.6);
    border-radius: 1rem;
    border: 1px solid rgba(34, 197, 94, 0.15);
  }

  .tab-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: transparent;
    border: none;
    border-radius: 0.75rem;
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .tab-btn svg {
    width: 18px;
    height: 18px;
  }

  .tab-btn:hover {
    color: rgba(255, 255, 255, 0.9);
    background: rgba(255, 255, 255, 0.05);
  }

  .tab-btn.active {
    color: #22c55e;
    background: rgba(34, 197, 94, 0.15);
  }

  .posts-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }

  @media (max-width: 767px) {
    .profile-tabs {
      overflow-x: auto;
      justify-content: flex-start;
      -webkit-overflow-scrolling: touch;
    }

    .tab-btn {
      padding: 0.5rem 1rem;
      white-space: nowrap;
    }

    .tab-btn span {
      display: none;
    }

    .posts-grid {
      gap: 2px;
    }
  }

  .empty-state {
    grid-column: 1 / -1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 4rem 2rem;
    text-align: center;
  }

  .empty-state svg {
    width: 64px;
    height: 64px;
    color: rgba(255, 255, 255, 0.2);
    margin-bottom: 1.5rem;
  }

  .empty-state h3 {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: rgba(255, 255, 255, 0.9);
  }

  .empty-state p {
    color: rgba(255, 255, 255, 0.5);
    margin-bottom: 1.5rem;
  }

  .profile-grid-item {
    position: relative;
    aspect-ratio: 1;
    overflow: hidden;
    border-radius: 4px;
    background: rgba(19, 25, 23, 0.5);
    cursor: pointer;
  }

  .profile-grid-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .profile-grid-item:hover img {
    transform: scale(1.05);
  }

  .grid-item-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.25s;
    color: white;
    font-size: 0.8rem;
    font-weight: 600;
  }

  .profile-grid-item:hover .grid-item-overlay {
    opacity: 1;
  }

  .text-grid-item {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    justify-content: space-between;
    padding: 0.85rem;
    background: linear-gradient(
      135deg,
      rgba(19, 25, 23, 0.9),
      rgba(34, 197, 94, 0.05)
    );
    border: 1px solid rgba(255, 255, 255, 0.06);
    text-decoration: none;
    border-left: 3px solid rgba(34, 197, 94, 0.3);
  }

  .text-grid-item p {
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.7);
    line-height: 1.5;
    margin: 0;
    text-align: left;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 4;
    -webkit-box-orient: vertical;
    flex: 1;
  }

  .grid-likes {
    font-size: 0.68rem;
    color: rgba(255, 255, 255, 0.4);
    margin-top: 0.5rem;
    padding-top: 0.35rem;
    border-top: 1px solid rgba(255, 255, 255, 0.04);
    width: 100%;
  }

  .reel-grid-item {
    text-decoration: none;
    display: block;
  }
</style>

<script>
  import { supabase } from "../lib/supabase/client";

  const tabBtns = document.querySelectorAll(".tab-btn");
  const postsGrid = document.getElementById("posts-grid") as HTMLDivElement;
  let currentTab = "posts";

  tabBtns.forEach((btn) => {
    btn.addEventListener("click", () => {
      tabBtns.forEach((b) => b.classList.remove("active"));
      btn.classList.add("active");
      currentTab = btn.getAttribute("data-tab") || "posts";
      loadTabContent(currentTab);
    });
  });

  async function loadTabContent(tab: string) {
    const {
      data: { user },
    } = await supabase.auth.getUser();
    if (!user) return;

    postsGrid.innerHTML =
      '<div style="grid-column:1/-1;text-align:center;padding:2rem;color:rgba(255,255,255,0.4);">Cargando...</div>';

    if (tab === "posts") {
      const { data: posts } = await (supabase as any)
        .from("posts")
        .select("id, content, media_urls, created_at, interactions(count)")
        .eq("user_id", user.id)
        .order("created_at", { ascending: false })
        .limit(30);

      renderPostsGrid(posts || []);
    } else if (tab === "reels") {
      const { data: reels } = await (supabase as any)
        .from("reels")
        .select(
          "id, video_url, thumbnail_url, caption, views_count, created_at",
        )
        .eq("user_id", user.id)
        .order("created_at", { ascending: false })
        .limit(30);

      renderReelsGrid(reels || []);
    } else if (tab === "saved") {
      const { data: saved } = await (supabase as any)
        .from("interactions")
        .select(
          "post_id, posts:post_id (id, content, media_urls, interactions(count))",
        )
        .eq("user_id", user.id)
        .eq("type", "save")
        .order("created_at", { ascending: false })
        .limit(30);

      const savedPosts = saved?.map((s: any) => s.posts).filter(Boolean) || [];
      renderPostsGrid(savedPosts);
    } else if (tab === "friends") {
      const { data: friendships } = await (supabase as any)
        .from("friendships")
        .select(
          `
          id, 
          requester_id, 
          addressee_id,
          requester:requester_id(username, display_name, avatar_url),
          addressee:addressee_id(username, display_name, avatar_url)
        `,
        )
        .or(`requester_id.eq.${user.id},addressee_id.eq.${user.id}`)
        .eq("status", "accepted");

      const friends = (friendships || []).map((f: any) => {
        return f.requester_id === user.id ? f.addressee : f.requester;
      });
      renderFriendsGrid(friends);
    } else {
      postsGrid.innerHTML =
        '<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:48px;height:48px;color:rgba(255,255,255,0.2);margin-bottom:1rem;"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg><h3>No hay etiquetas</h3><p>Aún no te han etiquetado en publicaciones.</p></div>';
    }
  }

  function renderPostsGrid(posts: any[]) {
    if (posts.length === 0) {
      postsGrid.innerHTML =
        '<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:48px;height:48px;color:rgba(255,255,255,0.2);margin-bottom:1rem;"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg><h3>No hay publicaciones aún</h3><p>Cuando publiques contenido, aparecerá aquí.</p><a href="/feed" class="btn btn-primary" style="margin-top:0.75rem;padding:0.6rem 1.25rem;background:linear-gradient(135deg,#22c55e,#15803d);border:none;border-radius:12px;color:white;font-weight:600;text-decoration:none;font-size:0.85rem;">Crear publicación</a></div>';
      return;
    }

    postsGrid.innerHTML = posts
      .map((post: any) => {
        const imgUrl =
          post.media_urls && post.media_urls.length > 0
            ? post.media_urls[0]
            : null;
        const lc = post.interactions?.[0]?.count || 0;
        if (imgUrl) {
          return `<div class="profile-grid-item"><img src="${imgUrl}" alt="" loading="lazy" /><div class="grid-item-overlay"><span>❤️ ${lc}</span></div></div>`;
        }
        return `<div class="profile-grid-item text-grid-item"><p>${(post.content || "").slice(0, 60)}</p><span class="grid-likes">❤️ ${lc}</span></div>`;
      })
      .join("");
  }

  function renderReelsGrid(reels: any[]) {
    if (reels.length === 0) {
      postsGrid.innerHTML =
        '<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:48px;height:48px;color:rgba(255,255,255,0.2);margin-bottom:1rem;"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg><h3>No hay reels</h3><p>Tus reels aparecerán aquí.</p></div>';
      return;
    }

    postsGrid.innerHTML = reels
      .map(
        (reel: any) => `
      <a href="/reels?reel=${reel.id}" class="profile-grid-item reel-grid-item">
        ${reel.thumbnail_url ? `<img src="${reel.thumbnail_url}" alt="" loading="lazy" />` : '<div style="background:#111;width:100%;height:100%;display:flex;align-items:center;justify-content:center;"><svg viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="1.5" width="28" height="28"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></div>'}
        <div class="grid-item-overlay"><span>▶ ${reel.views_count || 0}</span></div>
      </a>
    `,
      )
      .join("");
  }

  function renderFriendsGrid(friends: any[]) {
    if (friends.length === 0) {
      postsGrid.innerHTML =
        '<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:48px;height:48px;color:rgba(255,255,255,0.2);margin-bottom:1rem;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg><h3>No hay amigos aún</h3><p>Conecta con otras personas para verlas aquí.</p></div>';
      return;
    }

    postsGrid.innerHTML = friends
      .map(
        (friend: any) => `
      <a href="/profile/${friend.username}" class="profile-grid-item friend-grid-item" style="text-decoration:none;">
        <img src="${friend.avatar_url || "/images/default-avatar.svg"}" alt="${friend.username}" loading="lazy" />
        <div class="friend-info-overlay" style="position:absolute;bottom:0;left:0;right:0;padding:0.75rem;background:linear-gradient(to top, rgba(0,0,0,0.9), transparent);display:flex;flex-direction:column;">
          <span style="color:white;font-weight:600;font-size:0.85rem;">${friend.display_name || friend.username}</span>
          <span style="color:rgba(255,255,255,0.6);font-size:0.7rem;">@${friend.username}</span>
        </div>
      </a>
    `,
      )
      .join("");
  }

  // Load initial posts
  loadTabContent("posts");
</script>
