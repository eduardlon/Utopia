---
// Dynamic profile page - View other users' profiles
import AppLayout from "../../layouts/AppLayout.astro";
import ProfileHeader from "../../components/react/ProfileHeader";
import { getCurrentUser } from "../../lib/supabase/server";
import { supabase } from "../../lib/supabase/client";

const { username } = Astro.params;
const currentUser = await getCurrentUser(Astro);

// Fetch the profile by username
const { data: profile } = await (supabase as any)
  .from("profiles")
  .select("*")
  .eq("username", username)
  .single();

if (!profile) {
  return Astro.redirect("/explore");
}

const isOwnProfile = currentUser?.id === profile.id;

// If it's own profile, redirect to /profile
if (isOwnProfile) {
  return Astro.redirect("/profile");
}
---

<AppLayout title={`${profile.display_name || profile.username} - Utopía`}>
  <div class="profile-page">
    <ProfileHeader client:visible initialProfile={profile} isOwnProfile={false} />

    <!-- Profile Content Tabs -->
    <div class="profile-tabs">
      <button class="tab-btn active" data-tab="posts">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="7" height="7"></rect>
          <rect x="14" y="3" width="7" height="7"></rect>
          <rect x="14" y="14" width="7" height="7"></rect>
          <rect x="3" y="14" width="7" height="7"></rect>
        </svg>
        <span>Posts</span>
      </button>
      <button class="tab-btn" data-tab="reels">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="23 7 16 12 23 17 23 7"></polygon>
          <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
        </svg>
        <span>Reels</span>
      </button>
    </div>

    <!-- Posts Grid -->
    <div class="posts-grid" id="posts-grid">
      <div class="empty-state">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <circle cx="8.5" cy="8.5" r="1.5"></circle>
          <polyline points="21 15 16 10 5 21"></polyline>
        </svg>
        <h3>No hay publicaciones aún</h3>
        <p>Este usuario no ha publicado contenido todavía.</p>
      </div>
    </div>
  </div>
</AppLayout>

<!-- Pass profile ID to client script -->
<div id="profile-user-id" data-uid={profile.id} style="display:none;"></div>

<style>
  .profile-page {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .profile-tabs {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.5rem;
    background: rgba(18, 18, 18, 0.6);
    border-radius: 1rem;
    border: 1px solid rgba(34, 197, 94, 0.15);
  }

  .tab-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: transparent;
    border: none;
    border-radius: 0.75rem;
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: inherit;
  }

  .tab-btn svg {
    width: 18px;
    height: 18px;
  }

  .tab-btn:hover {
    color: rgba(255, 255, 255, 0.9);
    background: rgba(255, 255, 255, 0.05);
  }

  .tab-btn.active {
    color: #22c55e;
    background: rgba(34, 197, 94, 0.15);
  }

  .posts-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }

  @media (max-width: 767px) {
    .profile-tabs {
      overflow-x: auto;
      justify-content: flex-start;
      -webkit-overflow-scrolling: touch;
    }

    .tab-btn {
      padding: 0.5rem 1rem;
      white-space: nowrap;
    }

    .tab-btn span {
      display: none;
    }

    .posts-grid {
      gap: 2px;
    }
  }

  .empty-state {
    grid-column: 1 / -1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 4rem 2rem;
    text-align: center;
  }

  .empty-state svg {
    width: 64px;
    height: 64px;
    color: rgba(255, 255, 255, 0.2);
    margin-bottom: 1.5rem;
  }

  .empty-state h3 {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: rgba(255, 255, 255, 0.9);
  }

  .empty-state p {
    color: rgba(255, 255, 255, 0.5);
    margin-bottom: 1.5rem;
  }

  .profile-grid-item {
    position: relative;
    aspect-ratio: 1;
    overflow: hidden;
    border-radius: 4px;
    background: rgba(19, 25, 23, 0.5);
    cursor: pointer;
  }

  .profile-grid-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s cubic-bezier(0.4,0,0.2,1);
  }

  .profile-grid-item:hover img {
    transform: scale(1.05);
  }

  .grid-item-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.25s;
    color: white;
    font-size: 0.8rem;
    font-weight: 600;
  }

  .profile-grid-item:hover .grid-item-overlay {
    opacity: 1;
  }

  .text-grid-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 0.75rem;
    background: linear-gradient(135deg, rgba(19, 25, 23, 0.8), rgba(34, 197, 94, 0.06));
    border: 1px solid rgba(255,255,255,0.03);
  }

  .text-grid-item p {
    font-size: 0.72rem;
    color: rgba(255,255,255,0.6);
    line-height: 1.4;
    margin: 0;
    text-align: center;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
  }

  .grid-likes {
    font-size: 0.65rem;
    color: rgba(255,255,255,0.35);
    margin-top: 0.35rem;
  }
</style>

<script>
  import { supabase } from "../../lib/supabase/client";

  const profileUserId = document.getElementById("profile-user-id")?.getAttribute("data-uid") || "";
  const tabBtns = document.querySelectorAll(".tab-btn");
  const postsGrid = document.getElementById("posts-grid") as HTMLDivElement;

  tabBtns.forEach((btn) => {
    btn.addEventListener("click", () => {
      tabBtns.forEach((b) => b.classList.remove("active"));
      btn.classList.add("active");
      const tab = btn.getAttribute("data-tab") || "posts";
      loadTabContent(tab);
    });
  });

  async function loadTabContent(tab: string) {
    if (!profileUserId) return;

    postsGrid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:2rem;color:rgba(255,255,255,0.4);">Cargando...</div>';

    if (tab === "posts") {
      const { data: posts } = await (supabase as any)
        .from("posts")
        .select("id, content, media_urls, created_at, interactions(count)")
        .eq("user_id", profileUserId)
        .order("created_at", { ascending: false })
        .limit(30);

      renderPostsGrid(posts || []);
    } else if (tab === "reels") {
      const { data: reels } = await (supabase as any)
        .from("reels")
        .select("id, video_url, thumbnail_url, caption, views_count, created_at")
        .eq("user_id", profileUserId)
        .order("created_at", { ascending: false })
        .limit(30);

      renderReelsGrid(reels || []);
    }
  }

  function renderPostsGrid(posts: any[]) {
    if (posts.length === 0) {
      postsGrid.innerHTML = '<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:48px;height:48px;color:rgba(255,255,255,0.2);margin-bottom:1rem;"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg><h3>No hay publicaciones</h3><p>Este usuario no ha publicado contenido todavía.</p></div>';
      return;
    }

    postsGrid.innerHTML = posts.map((post: any) => {
      const imgUrl = post.media_urls && post.media_urls.length > 0 ? post.media_urls[0] : null;
      const lc = post.interactions?.[0]?.count || 0;
      if (imgUrl) {
        return `<div class="profile-grid-item"><img src="${imgUrl}" alt="" loading="lazy" /><div class="grid-item-overlay"><span>❤️ ${lc}</span></div></div>`;
      }
      return `<div class="profile-grid-item text-grid-item"><p>${(post.content || '').slice(0, 60)}</p><span class="grid-likes">❤️ ${lc}</span></div>`;
    }).join('');
  }

  function renderReelsGrid(reels: any[]) {
    if (reels.length === 0) {
      postsGrid.innerHTML = '<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:48px;height:48px;color:rgba(255,255,255,0.2);margin-bottom:1rem;"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg><h3>No hay reels</h3><p>Este usuario no ha publicado reels.</p></div>';
      return;
    }

    postsGrid.innerHTML = reels.map((reel: any) => `
      <a href="/reels" class="profile-grid-item" style="text-decoration:none;display:block;">
        ${reel.thumbnail_url ? `<img src="${reel.thumbnail_url}" alt="" loading="lazy" />` : '<div style="background:#111;width:100%;height:100%;display:flex;align-items:center;justify-content:center;"><svg viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="1.5" width="28" height="28"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></div>'}
        <div class="grid-item-overlay"><span>▶ ${reel.views_count || 0}</span></div>
      </a>
    `).join('');
  }

  // Load initial posts
  loadTabContent("posts");
</script>
